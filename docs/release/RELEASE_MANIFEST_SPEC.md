# Release Manifest Specification (v1)

This document defines the update metadata contract used by:
- installer/bootstrap scripts,
- in-app update checks.

The manifest is JSON and must be UTF-8 encoded.

## Canonical filename

- `manifest.json`
- Recommended release asset name: `manifest.json`
- Generated by: `.github/workflows/release-manifest.yml`

## Top-level schema

```json
{
  "schema_version": 1,
  "app_id": "albion-command-desk",
  "channel": "stable",
  "published_at": "2026-02-13T12:00:00Z",
  "latest": {
    "version": "0.1.1",
    "release_url": "https://github.com/D4dits/Albion-Command-Desk/releases/tag/v0.1.1",
    "changelog_url": "https://github.com/D4dits/Albion-Command-Desk/blob/main/CHANGELOG.md",
    "min_supported_version": "0.1.0"
  },
  "assets": [
    {
      "os": "windows",
      "arch": "x86_64",
      "kind": "installer",
      "name": "AlbionCommandDesk-Setup.exe",
      "url": "https://github.com/D4dits/Albion-Command-Desk/releases/download/v0.1.1/AlbionCommandDesk-Setup.exe",
      "sha256": "a3f0...9ab1",
      "size": 36713339
    }
  ]
}
```

## Required fields

Top-level:
- `schema_version` (integer): currently `1`.
- `app_id` (string): must be `albion-command-desk`.
- `channel` (string): one of `stable`, `beta`, `nightly`.
- `published_at` (RFC3339 UTC string).
- `latest` (object).
- `assets` (array, can be empty if only notifying version/changelog).

`latest`:
- `version` (string, semver without `v`, e.g. `0.1.1`).
- `release_url` (string, absolute HTTPS URL).
- `changelog_url` (string, absolute HTTPS URL).
- `min_supported_version` (string, semver).

`assets[]`:
- `os` (string): `windows`, `linux`, or `macos`.
- `arch` (string): `x86_64` or `arm64`.
- `kind` (string): `installer`, `archive`, or `bootstrap-script`.
- `name` (string): artifact filename.
- `url` (string, absolute HTTPS URL).
- `sha256` (string, lowercase hex digest).
- `size` (integer, bytes, > 0).

## Artifact matrix and naming contract (Phase 4 lock)

Canonical asset names (recommended):

- Windows installer: `AlbionCommandDesk-Setup-vX.Y.Z-x86_64.exe`
- Linux AppImage: `AlbionCommandDesk-vX.Y.Z-x86_64.AppImage`
- Linux bootstrap: `acd-install-linux-vX.Y.Z.sh`
- macOS DMG: `AlbionCommandDesk-vX.Y.Z-universal.dmg`
- macOS bootstrap: `acd-install-macos-vX.Y.Z.sh`

Manifest ordering rule:

- Preferred asset must appear first for each OS/arch tuple.
- Preferred assets:
  - Windows x86_64 -> `kind=installer`
  - Linux x86_64 -> `kind=archive` (AppImage)
  - macOS universal -> `kind=archive` (DMG)
- Secondary bootstrap script may follow as fallback.

## Compatibility and behavior rules

- Unknown fields must be ignored by clients (forward compatibility).
- Missing required fields must invalidate the manifest.
- Clients must ignore assets with unknown `os`, `arch`, or `kind`.
- `latest.version` newer than local version means update available.
- If local version `< min_supported_version`, client should show hard upgrade warning.
- If multiple assets match current OS/arch, client must pick the first matching one.

## Versioning policy

- Breaking schema changes require incrementing `schema_version`.
- `schema_version=1` contract is immutable once released.
- New optional fields are allowed without schema bump.

## Security requirements

- Manifest and assets must be served over HTTPS.
- Clients should verify `sha256` before using downloaded artifact.
- Do not embed secrets/tokens in the manifest.
- Rollback safety: keep a `last-known-good` manifest snapshot and never overwrite it without validation.

## Publishing

- Build command (local/manual):
  - `python tools/release/manifest/build_manifest.py --repo <owner/repo> --tag <tag> --output tools/release/manifest/manifest.json`
- Publish helper (Windows):
  - `powershell -ExecutionPolicy Bypass -File .\tools\release\manifest\publish_manifest.ps1 -Tag <tag>`
- CI workflow:
  - `.github/workflows/release-manifest.yml`
  - Triggers on `release.published` or `workflow_dispatch`.
  - Uploads `manifest.json` as:
    - workflow artifact,
    - release asset for the same tag.

## Phase 0 packaging strategy lock (artifact expectations)

Manifest validation currently uses this policy:

- Blockers (workflow fails):
  - Missing Windows `installer` asset for `x86_64`.
- Warnings only (workflow logs warning, release can continue):
  - Missing Linux asset of kind `archive` or `bootstrap-script`.
  - Missing macOS asset of kind `archive` or `bootstrap-script`.

This lock keeps release decisions deterministic during the current phase while Linux/macOS packaging is still being finalized.
