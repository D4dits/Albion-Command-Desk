from __future__ import annotations

from albion_dps.domain import NameRegistry, PartyRegistry
from albion_dps.models import PhotonMessage
from albion_dps.protocol.protocol16 import decode_operation_response

# Join response payload extracted from albion_combat_43_solo.pcap (operation response).
JOIN_RESPONSE_HEX = (
    "0100002a005f00690000a244017800000010398e20f6875dd142853b1783791e9e690273000644346469747303620406"
    "78000000050200010200077800000005000307000308730004323230390979000266c1efffffc3b8ffff0a6640129968"
    "0b664520e0000c664520e0000e66427c064d0f6c08de5e5d5b99f92a106643b08000116643b0800013664098a5ba146c"
    "08de5e5d5b99f92a1566447b80001666447b800018664120f5c3196c08de5e5d5b99f92a1a66457e40001b6646ea6000"
    "1d663ded097b1e6c08de5e5d582a63121f6f01206c0000058f2fa8408721690356a510226c00000560e1591214234469"
    "6900020000000100000d8d0000000300000908246904376418256c08de5e53ffcb5000266c00000002540bbcf0276901"
    "b77400286646aee8fa296c08dd278597d9120c2a7900056c00000000000000000000011ff5b43ccb0000000000000000"
    "000000000000000000000000000000002b62002c73000f7665746572616e2d666f756e6465722d69000000002e690000"
    "00002f730000306200316f0132780000001030f88c862bbfad4b9f58fc02b56130643379000a690000a24d0000a24c00"
    "00a24a0000a24b0000a2460000a2490000a24e0000a2470000a2480000a245357800000010a8813ad2bf29b442900ced"
    "9b69c8803436780000003000000000000000000000000000000000000000000000000000000000000000000000000000"
    "0000000000000000000000377800000010abbb1e74f245524fa23a54151aa01b893862013973000756696b696e67733a"
    "6c08de5b943e9ce5253b79000266c1207db5c243889a3c73002b404152454e414063363964393533332d666165652d34"
    "3834652d613665392d6262633963343663363461373d730004323030303e6c08de274aa60b71b2417300043230303042"
    "73003240484944454f555440343331374038393033333062652d363863312d346537632d613862622d33383436643332"
    "3732613161436c08de5e5d5b99f92a446962cae4364762464a6900941e1b4b663f6666674d6c08de2552e31f5f784e73"
    "00035358534f780000001052ec146dc683b944a3bf66f9b53b95ba50730000526902faf080536b2d28546b2710556b27"
    "10566200586c08de7134020f8a00596b01a85a6c08dd18949ab49c0e5b6c08de14c81c97ac275c7800000001005d7900"
    "016c08de5b925189259d5e780000000101606f01636c08de5e5d596a6824646c08de5e57eb1283e36562216644696c00"
    "030000000200000001ba5e7955000000040000000000add5ef0000000700000000ae69b9c5677900066c000000016331"
    "5fec00000000000000000000000000000000000000000000000000000000000000000000000000000000686201694469"
    "6c000300000000000000002476f4950000000100000000761bbd4c000000020000000301af6d446a7900076bffff0026"
    "004300a400e4ffffffff6b69000000007362017473000432303030776f0178620c7a6f01fd6b0002"
)


def test_decode_operation_response_join() -> None:
    payload = bytes.fromhex(JOIN_RESPONSE_HEX)
    response = decode_operation_response(payload)
    assert response.return_code == 0
    assert response.parameters.get(253) == 2
    assert response.parameters.get(0) == 41540
    assert response.parameters.get(2) == "D4dits"


def test_party_registry_join_seeds_self() -> None:
    payload = bytes.fromhex(JOIN_RESPONSE_HEX)
    message = PhotonMessage(opcode=1, event_code=None, payload=payload)
    party = PartyRegistry()
    names = NameRegistry()

    party.observe(message)
    party.sync_id_names(names)

    assert 41540 in party.snapshot_self_ids()
    assert party._self_name == "D4dits"
    assert names.lookup(41540) == "D4dits"
