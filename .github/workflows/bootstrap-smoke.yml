name: bootstrap-smoke

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "tools/install/**"
      - "tools/release/manifest/**"
      - "albion_dps/update/**"
      - ".github/workflows/bootstrap-smoke.yml"
  push:
    branches: ["main"]
    paths:
      - "tools/install/**"
      - "tools/release/manifest/**"
      - "albion_dps/update/**"
      - ".github/workflows/bootstrap-smoke.yml"

jobs:
  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Windows bootstrap smoke
        shell: powershell
        run: |
          powershell -ExecutionPolicy Bypass -File .\tools\install\windows\install.ps1 `
            -ProjectRoot "$PWD" `
            -VenvPath "$env:RUNNER_TEMP\acd-smoke-venv" `
            -Python "$env:pythonLocation\python.exe" `
            -ForceRecreateVenv `
            -SkipRun

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libpcap-dev
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Linux bootstrap smoke
        run: |
          bash ./tools/install/linux/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-venv" \
            --python "$pythonLocation/bin/python" \
            --force-recreate-venv \
            --skip-run

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          brew update
          brew install libpcap || true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run macOS bootstrap smoke
        run: |
          bash ./tools/install/macos/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-venv" \
            --python "$pythonLocation/bin/python" \
            --force-recreate-venv \
            --skip-run
