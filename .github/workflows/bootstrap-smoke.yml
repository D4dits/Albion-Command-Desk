name: bootstrap-smoke

on:
  workflow_dispatch:
  pull_request:
    paths:
      - "tools/install/**"
      - "tools/release/manifest/**"
      - "albion_dps/update/**"
      - ".github/workflows/bootstrap-smoke.yml"
  push:
    branches: ["main"]
    paths:
      - "tools/install/**"
      - "tools/release/manifest/**"
      - "albion_dps/update/**"
      - ".github/workflows/bootstrap-smoke.yml"

jobs:
  windows-core:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Windows bootstrap smoke
        shell: powershell
        run: |
          .\tools\install\windows\install.ps1 `
            -ProjectRoot "$PWD" `
            -VenvPath "$PWD\.venv-smoke" `
            -Python "$env:pythonLocation\python.exe" `
            -Profile core `
            -ForceRecreateVenv `
            -SkipRun

  linux-core:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libpcap-dev \
            libegl1 \
            libgl1 \
            libx11-6 \
            libx11-xcb1 \
            libxkbcommon-x11-0 \
            libxcb1 \
            libxcb-icccm4 \
            libxcb-image0 \
            libxcb-keysyms1 \
            libxcb-randr0 \
            libxcb-render-util0 \
            libxcb-shape0 \
            libxcb-xinerama0 \
            libxcb-xfixes0 \
            libxrender1 \
            libxi6
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Linux bootstrap smoke
        run: |
          bash ./tools/install/linux/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-venv" \
            --python "$pythonLocation/bin/python" \
            --profile core \
            --force-recreate-venv \
            --skip-run

  linux-capture-advisory:
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libpcap-dev
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run Linux capture profile smoke (advisory)
        run: |
          bash ./tools/install/linux/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-capture-venv" \
            --python "$pythonLocation/bin/python" \
            --profile capture \
            --force-recreate-venv \
            --skip-run

  macos-core:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          brew update
          brew install libpcap || true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run macOS bootstrap smoke
        run: |
          bash ./tools/install/macos/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-venv" \
            --python "$pythonLocation/bin/python" \
            --profile core \
            --force-recreate-venv \
            --skip-run

  macos-capture-advisory:
    runs-on: macos-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - name: Install system dependencies
        run: |
          brew update
          brew install libpcap || true
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Run macOS capture profile smoke (advisory)
        run: |
          bash ./tools/install/macos/install.sh \
            --project-root "$PWD" \
            --venv-path "$RUNNER_TEMP/acd-smoke-capture-venv" \
            --python "$pythonLocation/bin/python" \
            --profile capture \
            --force-recreate-venv \
            --skip-run
